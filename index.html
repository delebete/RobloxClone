<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blox World: Hybrid Networking</title>
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #232527; }
        #canvas-container { width: 100vw; height: 100vh; display: block; }
        
        /* Debugger */
        #debug-console {
            position: absolute; top: 10px; left: 10px; width: 300px; height: 150px;
            background: rgba(0, 0, 0, 0.7); color: #0f0; font-family: monospace; font-size: 11px;
            padding: 10px; border-radius: 4px; pointer-events: none; overflow-y: auto; z-index: 300;
            white-space: pre-wrap;
        }

        /* Room Code HUD */
        #room-hud {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6); padding: 10px 20px; border-radius: 20px;
            color: white; font-weight: bold; font-size: 16px; pointer-events: none;
            z-index: 100; display: none; border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        #room-hud span { color: #00ffaa; font-family: monospace; font-size: 18px; margin-left: 5px; }
        #room-hud .mode-badge { font-size: 10px; background: #444; padding: 2px 6px; border-radius: 4px; margin-left: 10px; vertical-align: middle; text-transform: uppercase; }

        /* Login Modal */
        #login-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #232527; z-index: 200; display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .login-box {
            background: #393b3d; padding: 30px; border-radius: 10px; text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); width: 340px;
        }
        .login-box h1 { color: white; margin-top: 0; margin-bottom: 5px;}
        .login-box p { color: #aaa; font-size: 12px; margin-bottom: 15px; }
        
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; color: #ccc; margin-bottom: 5px; font-size: 12px; }
        .login-box input[type="text"] {
            width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #555;
            background: #232527; color: white; font-size: 14px; box-sizing: border-box;
        }
        
        /* Toggle Switch */
        .mode-switch-container {
            background: #2a2c2e; padding: 10px; border-radius: 6px; margin-bottom: 15px;
            display: flex; align-items: center; justify-content: space-between;
            border: 1px solid #444;
        }
        .mode-label { color: white; font-size: 14px; font-weight: bold; }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 20px;
        }
        .slider:before {
            position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: #00a2ff; }
        input:checked + .slider:before { transform: translateX(20px); }
        .mode-desc { font-size: 10px; color: #888; margin-top: 5px; text-align: left; }

        #server-url-container { display: none; margin-bottom: 15px; text-align: left; }

        .btn-row { display: flex; gap: 10px; margin-top: 10px; }
        .btn-primary {
            flex: 1; padding: 12px; background: #00a2ff; color: white; border: none;
            border-radius: 5px; font-size: 14px; font-weight: bold; cursor: pointer;
        }
        .btn-primary:hover { background: #008ecc; }
        .btn-secondary {
            flex: 1; padding: 12px; background: #444; color: white; border: 1px solid #555;
            border-radius: 5px; font-size: 14px; font-weight: bold; cursor: pointer;
        }
        .btn-secondary:hover { background: #555; }
        
        #host-id-display-container { display: none; margin-top: 15px; background: #222; padding: 15px; border-radius: 5px; border: 1px solid #444; }
        #host-id-text { color: #00ffaa; font-family: monospace; font-size: 24px; letter-spacing: 2px; font-weight: bold; margin: 5px 0; }
        #copy-btn { margin-top: 5px; background: #333; color: white; border: none; padding: 5px 10px; cursor: pointer; font-size: 10px; border-radius: 3px; }

        #network-status { position: absolute; bottom: 10px; left: 10px; color: #888; font-size: 12px; pointer-events: none; z-index: 201; }

        /* Game UI */
        #ui-layer {
            position: absolute; top: 20px; left: 20px; color: white;
            background: rgba(0, 0, 0, 0.5); padding: 15px; border-radius: 8px;
            pointer-events: none; user-select: none; max-width: 300px; transition: opacity 0.3s;
        }
        
        /* Tools UI */
        #editor-ui {
            position: absolute; top: 60px; right: 20px; width: 240px;
            background: rgba(35, 37, 39, 0.95); color: white; padding: 15px;
            border-radius: 8px; border: 1px solid #444; display: none;
            max-height: calc(100vh - 140px); overflow-y: auto; z-index: 90;
        }
        
        #toggle-editor-btn {
            position: absolute; bottom: 20px; right: 20px; padding: 10px 20px;
            background: #00a2ff; color: white; border: none; border-radius: 4px;
            font-weight: bold; cursor: pointer; font-size: 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3); pointer-events: auto; z-index: 100; 
            display: none;
        }
        #toggle-editor-btn:hover { background: #008ecc; }

        /* Editor Styling */
        .editor-section { margin-bottom: 15px; border-bottom: 1px solid #555; padding-bottom: 10px; }
        .editor-section h3 { margin: 0 0 10px 0; font-size: 14px; text-transform: uppercase; color: #ccc; }
        .editor-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .tab-row { display: flex; margin-bottom: 15px; border-bottom: 2px solid #444; }
        .tab-btn { flex: 1; background: transparent; border: none; color: #aaa; padding: 8px; cursor: pointer; font-weight: bold; border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .tab-btn.active { color: #00a2ff; border-bottom-color: #00a2ff; }
        button.tool-btn { flex: 1; padding: 5px; background: #444; border: 1px solid #555; color: white; cursor: pointer; border-radius: 3px; }
        button.tool-btn:hover { background: #555; }
        button.tool-btn.active { background: #00a2ff; border-color: #00a2ff; }
        .checkbox-row { display: flex; align-items: center; gap: 10px; margin: 5px 0; background: #333; padding: 5px; border-radius: 4px; }
        input[type="checkbox"] { width: auto; margin: 0; cursor: pointer; }
        select, input[type="color"] { width: 100%; padding: 5px; background: #333; border: 1px solid #555; color: white; border-radius: 3px; margin-bottom: 5px; pointer-events: auto; }
        label { font-size: 12px; color: #aaa; display: block; margin-bottom: 2px; }

        /* Crosshair */
        #crosshair { position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; transform: translate(-50%, -50%); pointer-events: none; display: none; z-index: 10; }
        #crosshair::before, #crosshair::after { content: ''; position: absolute; background: rgba(255, 255, 255, 0.8); border-radius: 2px; }
        #crosshair::before { top: 9px; left: 0; width: 20px; height: 2px; }
        #crosshair::after { top: 0; left: 9px; width: 2px; height: 20px; }
        
        .key { background: #ddd; color: #333; padding: 2px 6px; border-radius: 4px; font-weight: bold; display: inline-block; min-width: 15px; text-align: center; }
        .status-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 12px; background: #444; margin-top: 5px; }
        .on { background: #2ecc71; color: white; }
        .off { background: #e74c3c; color: white; }
        .hidden { display: none; }
    </style>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <!-- Login Screen -->
    <div id="login-screen">
        <div class="login-box">
            <h1>Blox World</h1>
            <p>Multiplayer Demo</p>
            
            <div class="mode-switch-container">
                <div class="mode-label">Connection: <span id="mode-text">P2P</span></div>
                <label class="switch">
                    <input type="checkbox" id="net-mode-toggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="mode-desc" id="mode-desc">
                Direct connection. Free, but blocked by school Wi-Fi.
            </div>

            <!-- Server URL Input (Hidden by default) -->
            <div id="server-url-container">
                <label style="color:#ccc; font-size:12px;">Server URL (Glitch/Render)</label>
                <input type="text" id="server-url-input" placeholder="https://your-project.glitch.me">
            </div>
            
            <div class="input-group">
                <label>Username</label>
                <input type="text" id="username-input" placeholder="Your Name" maxlength="12" value="Guest">
            </div>

            <div class="btn-row">
                <button class="btn-secondary" id="host-btn">Host Game</button>
            </div>

            <div style="margin: 15px 0; border-bottom: 1px solid #555; position: relative;">
                <span style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: #393b3d; padding: 0 10px; color: #888; font-size: 12px;">OR JOIN</span>
            </div>

            <div class="input-group">
                <label>Room Code (6 Digits)</label>
                <input type="text" id="host-id-input" placeholder="e.g. 123456" maxlength="6" style="letter-spacing: 2px; font-family: monospace;">
            </div>
            
            <button class="btn-primary" id="join-btn">Join Game</button>
            
            <div id="host-id-display-container">
                <div style="font-size: 12px; color: #ccc; margin-bottom: 5px;">Share this Code:</div>
                <div id="host-id-text">...</div>
                <button id="copy-btn">Copy to Clipboard</button>
            </div>
            
            <p id="connection-msg" style="color:#ff4444; font-size:12px; margin-top:10px; display:none;"></p>
        </div>
    </div>

    <div id="room-hud">
        CODE: <span id="room-code-display"></span>
        <span id="mode-badge" class="mode-badge">P2P</span>
    </div>
    <div id="network-status">Idle</div>
    <div id="debug-console">System Ready...</div>

    <div id="crosshair"></div>

    <div id="ui-layer">
        <h1>Controls</h1>
        <p><span class="key">W</span> <span class="key">A</span> <span class="key">S</span> <span class="key">D</span> to Walk</p>
        <p><span class="key">Space</span> to Jump</p>
        <p><span class="key">Shift</span> Toggle Shift Lock</p>
        <p><span class="key">Right Click (Hold)</span> Rotate Camera</p>
        <div style="margin-top: 10px; border-top: 1px solid #666; padding-top: 10px;">
            <div>Shift Lock: <span id="shift-status" class="status-badge off">OFF</span></div>
        </div>
    </div>

    <button id="toggle-editor-btn">Open Tools</button>

    <div id="editor-ui">
        <div class="tab-row">
            <button class="tab-btn active" id="tab-avatar" onclick="window.gameEditor.setTab('avatar')">Avatar</button>
            <button class="tab-btn" id="tab-world" onclick="window.gameEditor.setTab('world')">Building</button>
        </div>
        
        <div id="content-avatar">
            <div class="editor-section">
                <h3>Wearables</h3>
                <div class="editor-row">
                    <button class="tool-btn" onclick="window.gameEditor.addPart('box')">Cube</button>
                    <button class="tool-btn" onclick="window.gameEditor.addPart('cylinder')">Cylinder</button>
                </div>
                <label>Attach To:</label>
                <select id="parent-selector">
                    <option value="torso">Torso</option>
                    <option value="head">Head</option>
                    <option value="leftArm">Left Arm</option>
                    <option value="rightArm">Right Arm</option>
                    <option value="leftLeg">Left Leg</option>
                    <option value="rightLeg">Right Leg</option>
                </select>
            </div>
        </div>

        <div id="content-world" class="hidden">
            <div class="editor-section">
                <h3>Create Part</h3>
                <div class="editor-row">
                    <button class="tool-btn" onclick="window.gameEditor.addWorldPart('box')">Part</button>
                    <button class="tool-btn" onclick="window.gameEditor.addWorldPart('cylinder')">Cylinder</button>
                </div>
                <div class="editor-row">
                      <button class="tool-btn" onclick="window.gameEditor.addWorldPart('wedge')">Wedge</button>
                </div>
            </div>
            <div class="editor-section">
                <h3>Baseplate</h3>
                <label>Baseplate Color</label>
                <input type="color" id="baseplate-color-picker" value="#999999">
            </div>
        </div>

        <div class="editor-section">
            <h3>Tools</h3>
            <div class="editor-row">
                <button class="tool-btn active" id="mode-translate" onclick="window.gameEditor.setMode('translate')">Move (1)</button>
                <button class="tool-btn" id="mode-rotate" onclick="window.gameEditor.setMode('rotate')">Rotate (2)</button>
                <button class="tool-btn" id="mode-scale" onclick="window.gameEditor.setMode('scale')">Scale (3)</button>
            </div>
            <label style="margin-top:5px;">Properties</label>
            <div class="checkbox-row">
                <input type="checkbox" id="check-anchor" checked onchange="window.gameEditor.setAnchored(this.checked)">
                <label for="check-anchor" style="color:white; cursor:pointer; margin:0;">Anchored</label>
            </div>
            <div class="checkbox-row">
                <input type="checkbox" id="check-collide" checked onchange="window.gameEditor.setCanCollide(this.checked)">
                <label for="check-collide" style="color:white; cursor:pointer; margin:0;">Can Collide</label>
            </div>
            <label>Color</label>
            <input type="color" id="color-picker" value="#ff0000">
            <button class="tool-btn" style="background: #e74c3c; margin-top:5px; width:100%;" onclick="window.gameEditor.deleteSelected()">Delete Selected</button>
        </div>
    </div>

    <div id="canvas-container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { TransformControls } from 'three/addons/controls/TransformControls.js';

        function log(msg) {
            const consoleEl = document.getElementById('debug-console');
            consoleEl.innerText += `\n> ${msg}`;
            consoleEl.scrollTop = consoleEl.scrollHeight;
            console.log(msg);
        }

        // --- NETWORK GLOBAL STATE ---
        const NetState = {
            mode: 'p2p', // 'p2p' or 'server'
            isHost: false,
            // P2P Stuff
            peer: null,
            conn: null,
            connections: [],
            // Server Stuff
            socket: null,
            id: null, // My ID
            code: null
        };

        let localPlayerName = "Guest";
        let isGameActive = false;
        const remotePlayers = {}; 
        const worldObjects = {}; 

        // --- CONFIGS ---
        const P2P_PREFIX = 'blox-p2p-2025-';
        const peerConfig = {
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    {
                        urls: "turn:openrelay.metered.ca:80",
                        username: "openrelayproject",
                        credential: "openrelayproject"
                    }
                ]
            }
        };

        // --- UI LOGIC: MODE TOGGLE ---
        const toggleEl = document.getElementById('net-mode-toggle');
        const modeTextEl = document.getElementById('mode-text');
        const modeDescEl = document.getElementById('mode-desc');
        const serverUrlContainer = document.getElementById('server-url-container');
        const serverUrlInput = document.getElementById('server-url-input');

        // Load saved URL
        if(localStorage.getItem('blox_server_url')) {
            serverUrlInput.value = localStorage.getItem('blox_server_url');
        }

        toggleEl.addEventListener('change', () => {
            if(toggleEl.checked) {
                NetState.mode = 'server';
                modeTextEl.textContent = "Server";
                modeDescEl.textContent = "Requires Hosting. Bypasses all firewalls. No limits.";
                serverUrlContainer.style.display = 'block';
            } else {
                NetState.mode = 'p
